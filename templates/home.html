{% extends "base.html" %}

{% block body %}

<div class="container-fluid">
    <div class="row">
        <div id="sb" class="col-auto col-md-2 col-xl-1 px-sm-2 px-0 sidebar-custom" >
            <div class="d-flex flex-column align-items-center align-items-sm-start px-3 pt-2 min-vh-100">
                <a href="{{ url_for('home') }}" id="main-logo" class="d-flex align-items-center pb-3 mb-md-0 me-md-auto text-decoration-none fs-leckerli-one">
                    <span class="fs-5 d-none d-sm-inline">QuizifAI</span>
                </a>
                <ul class="nav nav-pills flex-column mb-sm-auto mb-0 align-items-center align-items-sm-start flex-grow-1">
                    <li class="nav-item">
                        <a href="{{ url_for('home') }}" class="nav-link align-middle px-0 active">
                            <i class="bi bi-house-door"></i>
                            <span class="ms-1 d-none d-sm-inline">Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('quizzes') }}" class="nav-link px-0 align-middle">
                            <i class="bi bi-pencil-square"></i>
                            <span class="ms-1 d-none d-sm-inline">Quizzes</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('analytics') }}" class="nav-link px-0 align-middle">
                            <i class="bi bi-graph-up-arrow"></i>
                            <span class="ms-1 d-none d-sm-inline">Analytics</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('settings') }}" class="nav-link px-0 align-middle">
                            <i class="bi bi-gear"></i>
                            <span class="ms-1 d-none d-sm-inline">Settings</span>
                        </a>
                    </li>
                </ul>
                
                <!-- User Info and Logout at Bottom -->
                <div class="w-100 mt-auto mb-3">
                    <div class="text-center mb-2">
                        <small class="text-decoration">Welcome, {{ current_user.username }}!</small>
                    </div>
                    <div class="d-grid">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm" style="border-radius: 20px; font-size: 0.85rem;">
                            <i class="bi bi-box-arrow-right me-1"></i>
                            <span class="d-none d-sm-inline">Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col p-3 p-md-5" x-data="{ showWelcome: true }" x-on:show-quiz.window="showWelcome = false">
            <!-- Loading Overlay - Hidden by default, only shown when form is submitted -->
            <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" style="background-color: rgba(0, 0, 0, 0.7); z-index: 1050;">
                <div class="loading-container mx-auto" style="max-width: 500px;">
                    <div class="spinner-border text-light mb-3" role="status">
                        <span class="visually-hidden">Generating questions...</span>
                    </div>
                    <h4 class="mb-2 text-light">Generating Your Questions</h4>
                    <p class="text-light mb-0">Our AI is analyzing your study material and creating personalized questions for your collection...</p>
                </div>
            </div>

            <!-- Welcome Section - Hidden when quiz is loaded -->
            <div x-show="showWelcome" x-transition class="welcome-section text-center">
                <h1 class="welcome-title">
                    Welcome back, {{ current_user.username }}! 
                    <br>
                    <small class="mute-color">Generate questions and build your personal quiz collection.</small>
                    <br>
                </h1>

                <div class="d-flex justify-content-center align-items-center mt-4 mt-md-5">
                    <form
                        id="study-form"
                        method="POST"
                        class="study-form-modern"
                        enctype="multipart/form-data"
                    >
                        <div class="form-container p-4 rounded-4" style="background: linear-gradient(145deg, oklch(20% 0.025 329.708), oklch(18% 0.02 329.708)); border: 1px solid oklch(25% 0.03 329.708); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
                            
                            <!-- File Upload Section -->
                            <div class="file-upload-section mb-4">
                                <label for="file-input" class="file-upload-label d-flex align-items-center justify-content-center p-4 rounded-3 mb-3" 
                                       style="background-color: oklch(25% 0.03 329.708); border: 2px dashed oklch(42.621% 0.074 224.389deg); cursor: pointer; transition: all 0.3s ease;">
                                    <div class="text-center">
                                        <i class="bi bi-cloud-upload fs-2 mb-2" style="color: oklch(71.996% 0.123 62.756deg);"></i>
                                        <div class="fw-bold" style="color: oklch(71.996% 0.123 62.756deg);">Choose File</div>
                                        <small class="text-muted">Supports PDFs or images (PNG/JPG)</small>
                                    </div>
                                </label>
                                <input type="file" id="file-input" name="file" accept=".pdf,.png,.jpg,.jpeg,.heic" class="d-none">
                                <div id="file-name" class="file-name-display text-center small text-muted"></div>
                            </div>

                            <!-- Divider -->
                            <div class="divider-section mb-4">
                                <div class="d-flex align-items-center">
                                    <hr class="flex-grow-1" style="border-color: oklch(30% 0.03 329.708);">
                                    <span class="px-3 small text-muted">OR</span>
                                    <hr class="flex-grow-1" style="border-color: oklch(30% 0.03 329.708);">
                                </div>
                            </div>
                            
                            <!-- Text Input Section -->
                            <div class="text-input-section mb-4">
                                <div>
                                    <textarea 
                                        name="study_material" 
                                        id="study-input"
                                        class="form-control custom-textarea" 
                                        placeholder="Enter your study material here..."
                                        style="height: 100px; background-color: oklch(22% 0.025 329.708); border: 1px solid oklch(30% 0.03 329.708); color: oklch(80% 0.1 62.756deg); resize: vertical;"
                                    ></textarea>
                                </div>
                            </div>
                            
                            <!-- Generate Button -->
                            <div class="text-center">
                                <button 
                                    class="btn btn-lg gen-btn-modern px-5 py-3 fw-bold" 
                                    type="submit"
                                    style="background: linear-gradient(135deg, oklch(71.996% 0.123 62.756deg), oklch(65% 0.11 62.756deg)); 
                                           color: oklch(16.51% 0.015 326.261deg); 
                                           border: none; 
                                           border-radius: 50px; 
                                           box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                                           transition: all 0.3s ease;
                                           min-width: 200px;
                                           white-space: nowrap;"
                                >
                                    <i class="bi bi-magic me-2"></i>Generate Questions
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Questions Selection Section - Hidden by default, shown when questions are generated -->
            <div x-show="!showWelcome" x-transition class="quiz-section">
                <div class="quiz-header mb-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="mb-0">Generated Questions</h2>
                        <button @click="showWelcome = true" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-arrow-left me-2"></i>
                            Generate New Questions
                        </button>
                    </div>
                </div>

                <!-- Questions Container -->
                <div id="quiz-container" x-data="authenticatedQuizApp" x-init="init()" class="quiz-content">
                    <!-- Error State -->
                    <div x-show="error" class="alert alert-danger" role="alert">
                        <strong>Oops!</strong> <span x-text="error"></span>
                    </div>
                    
                    <!-- Generated Questions -->
                    <div x-show="questions.length > 0" class="questions-container">
                        <div class="mb-4">
                            <p class="text-muted">Select the questions you'd like to save to your quiz collection:</p>
                        </div>
                        
                        <div class="row g-4">
                            <template x-for="question in questions" :key="question.id">
                                <div class="col-lg-6 col-xl-4">
                                    <div class="question-card p-4 rounded h-100 position-relative" 
                                         style="background-color: oklch(16% 0.019 329.708);"
                                         :class="{'border border-success': question.saved}">
                                        
                                        <!-- Save Button -->
                                        <div class="position-absolute top-0 end-0 m-3">
                                            <button @click="openQuizModal(question.id)" 
                                                    :disabled="question.saving || question.saved"
                                                    class="btn btn-sm"
                                                    :class="question.saved ? 'btn-success' : 'btn-outline-light'">
                                                <i x-show="!question.saving && !question.saved" class="bi bi-plus-circle"></i>
                                                <i x-show="question.saving" class="bi bi-arrow-repeat spin"></i>
                                                <i x-show="question.saved" class="bi bi-check-circle-fill"></i>
                                                <span x-text="question.saved ? 'Saved' : (question.saving ? 'Saving...' : 'Save')"></span>
                                            </button>
                                        </div>
                                        
                                        <h5 class="question-text mb-4 pe-5" x-text="question.text"></h5>
                                        
                                        <div class="answers-container">
                                            <template x-for="(answer, index) in question.answers" :key="index">
                                                <div class="answer-option mb-3">
                                                    <div class="d-flex align-items-center gap-3 p-3 rounded" style="background-color: oklch(20% 0.025 329.708);">
                                                        <span class="answer-label badge rounded-pill px-3 py-2" 
                                                              style="background-color: oklch(34.465% 0.029 199.194);"
                                                              x-text="String.fromCharCode(65 + index) + '.'">
                                                        </span>
                                                        <span class="answer-text flex-grow-1" x-text="answer"></span>
                                                        
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Bulk Actions -->
                        <div class="text-center mt-4">
                            <button @click="saveAllQuestions()" class="btn gen-btn-modern me-3 text-muted">
                                <i class="bi bi-collection me-2"></i>
                                Save All Questions
                            </button>
                            <a href="{{ url_for('quizzes') }}" class="btn btn-outline-light">
                                <i class="bi bi-arrow-right me-2"></i>
                                Go to My Quizzes
                            </a>
                        </div>
                    </div>

                    <!-- Custom Save to Quiz Modal -->
                    <div x-show="showQuizModal" 
                        class="custom-modal"
                        x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0"
                        x-transition:enter-end="opacity-100"
                        x-transition:leave="transition ease-in duration-200"
                        x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                        @click.self="closeQuizModal()">
                         <div class="custom-modal-content" style="background-color: oklch(20% 0.025 329.708); color: oklch(71.996% 0.123 62.756deg); border: 1px solid oklch(25% 0.03 329.708);">
                             <div class="custom-modal-header" style="border-bottom: 1px solid oklch(25% 0.03 329.708);">
                                 <h5 class="custom-modal-title">Save to Quiz</h5>
                                 <button type="button" class="custom-modal-close" @click="closeQuizModal()" style="color: oklch(71.996% 0.123 62.756deg);">&times;</button>
                             </div>
                             <div class="custom-modal-body">
                                <p class="mb-3">Select a quiz to save this question to:</p>
                                 <div class="list-group mb-3">
                                     <template x-for="quiz in quizzes" :key="quiz.id">
                                         <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                                             @click="saveQuestion(quiz.id)"
                                             style="background-color: oklch(22% 0.025 329.708); border: 1px solid oklch(30% 0.03 329.708); color: oklch(80% 0.1 62.756deg); cursor: pointer;">
                                             <span x-text="quiz.title"></span>
                                             <small class="text-muted" x-text="quiz.question_count + ' questions'"></small>
                                         </div>
                                     </template>
                                     <div x-show="!quizzes || quizzes.length === 0" class="list-group-item text-muted" style="background-color: oklch(22% 0.025 329.708); border: 1px solid oklch(30% 0.03 329.708);">
                                         No quizzes available
                                     </div>
                                 </div>
                                
                                <hr class="my-3">
                                
                                <p class="mb-3">Or create a new quiz:</p>
                                 <form @submit.prevent="createAndSaveToNewQuiz()">
                                     <div class="input-group">
                                         <input type="text" 
                                             class="form-control" 
                                             placeholder="Enter new quiz name" 
                                             x-model="newQuizName"
                                             required
                                             style="background-color: oklch(22% 0.025 329.708); border: 1px solid oklch(30% 0.03 329.708); color: oklch(80% 0.1 62.756deg);">
                                         <button class="btn btn-primary" type="submit" :disabled="!newQuizName || !newQuizName.trim()" style="background-color: oklch(34.465% 0.029 199.194); border-color: oklch(34.465% 0.029 199.194);">
                                             Create & Save
                                         </button>
                                     </div>
                                 </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}