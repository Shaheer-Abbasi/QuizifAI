{% extends "base.html" %}

{% block body %}

<div class="container-fluid">
    <div class="row">
        <div id="sb" class="col-auto col-md-2 col-xl-1 px-sm-2 px-0 sidebar-custom" >
            <div class="d-flex flex-column align-items-center align-items-sm-start px-3 pt-2 min-vh-100">
                <a href="{{ url_for('home') }}" id="main-logo" class="d-flex align-items-center pb-3 mb-md-0 me-md-auto text-decoration-none fs-leckerli-one">
                    <span class="fs-5 d-none d-sm-inline">QuizifAI</span>
                </a>
                <ul class="nav nav-pills flex-column mb-sm-auto mb-0 align-items-center align-items-sm-start flex-grow-1">
                    <li class="nav-item">
                        <a href="{{ url_for('home') }}" class="nav-link align-middle px-0">
                            <i class="bi bi-house-door"></i>
                            <span class="ms-1 d-none d-sm-inline">Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('quizzes') }}" class="nav-link px-0 align-middle active">
                            <i class="bi bi-pencil-square"></i>
                            <span class="ms-1 d-none d-sm-inline">Quizzes</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('analytics') }}" class="nav-link px-0 align-middle">
                            <i class="bi bi-graph-up-arrow"></i>
                            <span class="ms-1 d-none d-sm-inline">Analytics</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('settings') }}" class="nav-link px-0 align-middle">
                            <i class="bi bi-gear"></i>
                            <span class="ms-1 d-none d-sm-inline">Settings</span>
                        </a>
                    </li>
                </ul>
                
                <!-- User Info and Logout at Bottom -->
                <div class="w-100 mt-auto mb-3">
                    <div class="text-center mb-2">
                        <small class="text-decoration">Welcome, {{ current_user.username }}!</small>
                    </div>
                    <div class="d-grid">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm" style="border-radius: 20px; font-size: 0.85rem;">
                            <i class="bi bi-box-arrow-right me-1"></i>
                            <span class="d-none d-sm-inline">Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col p-3 p-md-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">My Quizzes</h1>
                <button class="btn gen-btn-modern px-2 py-2 text-muted" data-modal-target="createQuizModal" onclick="const modal = document.getElementById('createQuizModal'); if(modal) { modal.style.display='block'; document.body.style.overflow='hidden'; } else { console.error('Modal not found'); }">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create New Quiz
                </button>
            </div>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% if quizzes %}
                <div class="row g-4">
                    {% for quiz in quizzes %}
                        <div class="col-md-6 col-lg-4">
                            <div class="quiz-card p-4 rounded h-100 position-relative" 
                                 style="background: linear-gradient(145deg, oklch(20% 0.025 329.708), oklch(18% 0.02 329.708)); border: 1px solid oklch(25% 0.03 329.708); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);">
                                
                                <!-- Quiz metadata -->
                                <div class="d-flex justify-content-between mb-3">
                                    <h5 class="mb-0">{{ quiz.title }}</h5>
                                    <span class="badge rounded-pill px-3 py-2" 
                                          style="background-color: oklch(34.465% 0.029 199.194);">
                                        {{ quiz.questions|length }} Questions
                                    </span>
                                </div>
                                
                                <div class="text-muted small mb-3">
                                    <i class="bi bi-calendar3 me-2"></i>
                                    Created on {{ quiz.created_at.strftime('%b %d, %Y') }}
                                </div>
                                
                                <!-- Quiz stats -->
                                <div class="mb-4">
                                    {% if quiz.attempts|length > 0 %}
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-trophy me-2" style="color: oklch(71.996% 0.123 62.756deg);"></i>
                                            <span>Best score: {{ quiz.attempts|map(attribute='score')|max }}/{{ quiz.attempts[0].total_questions }}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-activity me-2" style="color: oklch(71.996% 0.123 62.756deg);"></i>
                                            <span>Attempts: {{ quiz.attempts|length }}</span>
                                        </div>
                                    {% else %}
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <span class="text-muted">No attempts yet</span>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Actions -->
                                <div class="d-flex gap-2 mt-auto">
                                    <a href="{{ url_for('take_quiz', quiz_id=quiz.id) }}" class="btn btn-outline-light flex-grow-1">
                                        <i class="bi bi-play-circle me-2"></i>
                                        Start Quiz
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5 my-5">
                    <div class="mb-4">
                        <i class="bi bi-journal-bookmark" style="font-size: 3rem; color: oklch(50% 0.06 62.756deg);"></i>
                    </div>
                    <h3>No Quizzes Yet</h3>
                    <p class="text-muted">Generate questions on the home page and save them to your collection.</p>
                    <div class="d-flex justify-content-center">
                        <a href="{{ url_for('home') }}" class="btn gen-btn-modern mt-3 text-muted">
                        <i class="bi bi-plus-circle me-2"></i>
                        Try Question Generation
                        </a>
                    </div>
                    
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Custom Create Quiz Modal -->
<div id="createQuizModal" class="create-quiz-modal" x-data="{ newQuizTitle: '', showModal: false }">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h5 class="custom-modal-title">Create New Quiz</h5>
            <button type="button" class="custom-modal-close" @click="showModal = false; newQuizTitle = ''">&times;</button>
        </div>
        <form @submit.prevent="
            if (newQuizTitle && newQuizTitle.trim()) {
                fetch('/create-quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ title: newQuizTitle.trim() })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showModal = false;
                        newQuizTitle = '';
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error creating quiz');
                });
            }
        ">
            <div class="custom-modal-body">
                <div class="mb-3">
                    <label for="quizTitle" class="form-label">Quiz Title</label>
                    <input type="text" class="form-control" id="quizTitle" x-model="newQuizTitle" required
                           style="background-color: oklch(22% 0.025 329.708); border: 1px solid oklch(30% 0.03 329.708); color: oklch(80% 0.1 62.756deg);">
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-outline-light" @click="showModal = false; newQuizTitle = ''">Cancel</button>
                <button type="submit" class="btn gen-btn-modern text-muted" :disabled="!newQuizTitle || !newQuizTitle.trim()">Create Quiz</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Simple modal control functions - make globally accessible
    window.openCreateQuizModal = function() {
        const modal = document.getElementById('createQuizModal');
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            // Set showModal to true for Alpine.js
            const alpineData = Alpine.$data(modal);
            if (alpineData) {
                alpineData.showModal = true;
            }
        }
    };

    // Make functions globally accessible
    window.confirmDeleteQuiz = function(quizId, quizTitle) {
        console.log('confirmDeleteQuiz called with:', quizId, quizTitle);
        document.getElementById('deleteQuizName').textContent = quizTitle;
        document.getElementById('deleteQuizForm').action = `/delete-quiz/${quizId}`;
        
        const modal = document.getElementById('deleteQuizModal');
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    };

    // Debug: Check if functions are defined
    console.log('Functions defined:', {
        openCreateQuizModal: typeof window.openCreateQuizModal,
        confirmDeleteQuiz: typeof window.confirmDeleteQuiz
    });
});
</script>

<!-- Custom Delete Quiz Modal -->
<div id="deleteQuizModal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h5 class="custom-modal-title">Confirm Deletion</h5>
            <button type="button" class="custom-modal-close" data-modal-close="deleteQuizModal">&times;</button>
        </div>
        <div class="custom-modal-body">
            <p>Are you sure you want to delete the quiz "<span id="deleteQuizName"></span>"?</p>
            <p class="text-danger">This action cannot be undone.</p>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-outline-light" data-modal-close="deleteQuizModal">Cancel</button>
            <form id="deleteQuizForm" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-danger">Delete Quiz</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Modal functionality with debugging
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, setting up modal handlers');
        
        // Check if elements exist
        const createButton = document.querySelector('[data-modal-target="createQuizModal"]');
        const createModal = document.getElementById('createQuizModal');
        console.log('Create button:', createButton);
        console.log('Create modal:', createModal);
        
        // Open modal when clicking buttons with data-modal-target
        document.addEventListener('click', function(event) {
            console.log('Click event:', event.target);
            
            // Check if clicked element or its parent has data-modal-target
            const targetButton = event.target.closest('[data-modal-target]');
            if (targetButton) {
                console.log('Found target button:', targetButton);
                const modalId = targetButton.getAttribute('data-modal-target');
                console.log('Modal ID:', modalId);
                const modal = document.getElementById(modalId);
                console.log('Modal element:', modal);
                
                if (modal) {
                    console.log('Opening modal');
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } else {
                    console.error('Modal not found:', modalId);
                }
            }
        });
        
        // Close modal when clicking close buttons or cancel buttons
        document.addEventListener('click', function(event) {
            const closeButton = event.target.closest('[data-modal-close]');
            if (closeButton) {
                const modalId = closeButton.getAttribute('data-modal-close');
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    // Clear form if it's the create quiz modal
                    if (modalId === 'createQuizModal') {
                        const form = document.getElementById('createQuizForm');
                        if (form) form.reset();
                    }
                }
            }
        });
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('custom-modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const openModals = document.querySelectorAll('.custom-modal[style*="block"]');
                openModals.forEach(modal => {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
            }
        });
        
    });
</script>
